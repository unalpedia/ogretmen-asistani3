import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { AlertCircle, Users, BookOpen, Trophy, BarChart3, FileText, Sparkles, Plus, X, Save, Trash2 } from 'lucide-react';

// ============================================================================
// GÜVENLIK VE YARDIMCI FONKSİYONLAR
// ============================================================================

const sanitize = (input) => {
  if (!input) return '';
  return String(input)
    .replace(/[<>]/g, '')
    .trim()
    .slice(0, 100);
};

const storage = {
  set: (key, value) => {
    try {
      const serialized = JSON.stringify(value);
      if (serialized.length > 4 * 1024 * 1024) {
        throw new Error('Veri çok büyük (max 4MB)');
      }
      localStorage.setItem(key, serialized);
      return { success: true };
    } catch (e) {
      console.error('Storage hatası:', e);
      return { success: false, error: e.message };
    }
  },
  get: (key, defaultValue = null) => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch {
      return defaultValue;
    }
  },
  remove: (key) => {
    try {
      localStorage.removeItem(key);
      return { success: true };
    } catch (e) {
      return { success: false, error: e.message };
    }
  }
};

const generateId = () => `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

const playRollSound = () => {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(220 + (Math.random() * 80), ctx.currentTime);
    gain.gain.setValueAtTime(0.04, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
    osc.start();
    osc.stop(ctx.currentTime + 0.1);
  } catch(e) {
    console.log('Ses çalınamadı');
  }
};

// ============================================================================
// CUSTOM HOOKS
// ============================================================================

const useLocalStorageState = (key, defaultValue) => {
  const [state, setState] = useState(() => storage.get(key, defaultValue));

  useEffect(() => {
    const result = storage.set(key, state);
    if (!result.success) {
      console.error('Veri kaydedilemedi:', result.error);
    }
  }, [key, state]);

  return [state, setState];
};

// ============================================================================
// COMPONENTS
// ============================================================================

const ErrorBoundary = ({ children }) => {
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    const handler = (event) => {
      console.error('Hata yakalandı:', event.error);
      setHasError(true);
    };
    window.addEventListener('error', handler);
    return () => window.removeEventListener('error', handler);
  }, []);

  if (hasError) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md text-center">
          <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
          <h2 className="text-2xl font-bold mb-2">Bir Hata Oluştu</h2>
          <p className="text-slate-600 mb-4">Lütfen sayfayı yenileyin</p>
          <button 
            onClick={() => window.location.reload()} 
            className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold"
          >
            Sayfayı Yenile
          </button>
        </div>
      </div>
    );
  }

  return children;
};

const HybridChart = ({ stdId, students, exams }) => {
  const width = 800;
  const height = 240;
  const padding = 40;
  
  const examPoints = exams.map((e, i) => {
    const net = Number(e.results?.[stdId]?.net) || 0;
    const qCount = Number(e.qCount) || 1;
    const percentage = (net / qCount) * 100;
    const x = padding + (i * (width - 2 * padding) / Math.max(exams.length - 1, 1));
    const y = height - padding - ((percentage / 100) * (height - 2 * padding));
    return { x, y, val: percentage };
  });

  const std = students.find(s => s.id === stdId);
  const logs = [...(std?.logs || [])].reverse().slice(-10);
  const puanPoints = logs.map((l, i) => {
    const x = padding + (i * (width - 2 * padding) / Math.max(logs.length - 1, 1));
    const y = height - padding - ((l.currentTotal / 1000) * (height - 2 * padding));
    return { x, y };
  });

  return (
    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto" role="img" aria-label="Öğrenci performans grafiği">
      <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#cbd5e1" strokeWidth="2" />
      <line x1={padding} y1={height-padding - (0.5 * (height-2*padding))} x2={width-padding} y2={height-padding - (0.5 * (height-2*padding))} stroke="#f1f5f9" strokeWidth="1" />
      
      {puanPoints.length > 1 && (
        <path 
          d={`M ${puanPoints.map(p => `${p.x},${p.y}`).join(' L ')}`} 
          fill="none" 
          stroke="#10b981" 
          strokeWidth="2" 
          strokeDasharray="6" 
        />
      )}
      
      {examPoints.length > 1 && (
        <path 
          d={`M ${examPoints.map(p => `${p.x},${p.y}`).join(' L ')}`} 
          fill="none" 
          stroke="#f59e0b" 
          strokeWidth="3" 
          strokeLinejoin="round" 
        />
      )}
      
      {examPoints.map((p, i) => (
        <g key={i}>
          <circle cx={p.x} cy={p.y} r="5" fill="#f59e0b" />
          <text x={p.x} y={p.y - 12} textAnchor="middle" fontSize="10" fontWeight="800" fill="#b45309">
            %{p.val.toFixed(0)}
          </text>
        </g>
      ))}
    </svg>
  );
};

const Tab = ({ active, onClick, icon: Icon, label }) => (
  <button
    onClick={onClick}
    className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs transition-all ${
      active ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-50'
    }`}
    aria-pressed={active}
  >
    <Icon className="w-4 h-4" />
    <span className="hidden sm:inline">{label}</span>
  </button>
);

const Dashboard = ({ classes, onAddClass, onSelectClass, onDeleteClass }) => (
  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-10">
    <button
      onClick={onAddClass}
      className="h-44 border-4 border-dashed border-slate-300 rounded-3xl font-bold text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-all flex items-center justify-center gap-2"
      aria-label="Yeni sınıf ekle"
    >
      <Plus className="w-6 h-6" />
      <span>Yeni Sınıf</span>
    </button>
    {classes.map(c => (
      <div
        key={c.id}
        onClick={() => onSelectClass(c)}
        className="bg-white p-10 rounded-3xl shadow-xl border-b-8 border-indigo-600 hover:-translate-y-2 transition-all cursor-pointer relative group"
        role="button"
        tabIndex={0}
        onKeyPress={(e) => e.key === 'Enter' && onSelectClass(c)}
      >
        <button
          onClick={(e) => {
            e.stopPropagation();
            onDeleteClass(c.id);
          }}
          className="absolute top-5 right-5 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"
          aria-label={`${c.name} sınıfını sil`}
        >
          <Trash2 className="w-5 h-5" />
        </button>
        <h3 className="text-3xl font-bold text-slate-800">{c.name}</h3>
      </div>
    ))}
  </div>
);

const StudentList = ({ students, onAddStudent, onAddBulk, onDeleteStudent }) => {
  const [name, setName] = useState('');
  const [bulkText, setBulkText] = useState('');
  const [showBulk, setShowBulk] = useState(false);

  const handleAddStudent = () => {
    const cleaned = sanitize(name);
    if (cleaned) {
      onAddStudent(cleaned);
      setName('');
    }
  };

  const handleAddBulk = () => {
    const names = bulkText
      .split('\n')
      .map(line => sanitize(line))
      .filter(line => line.length > 0);
    
    if (names.length > 0) {
      onAddBulk(names);
      setBulkText('');
      setShowBulk(false);
    }
  };

  return (
    <div className="bg-white rounded-3xl p-10 shadow-2xl">
      <div className="flex justify-between items-center mb-8 border-b pb-4">
        <h2 className="text-2xl font-bold flex items-center gap-2">
          <Users className="w-6 h-6" />
          Öğrenci Yönetimi
        </h2>
        <button
          onClick={() => setShowBulk(!showBulk)}
          className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold text-xs flex items-center gap-2"
        >
          <Plus className="w-4 h-4" />
          {showBulk ? 'Tekil Ekle' : 'Toplu Ekle'}
        </button>
      </div>

      {showBulk ? (
        <div className="mb-8 space-y-4">
          <textarea
            value={bulkText}
            onChange={(e) => setBulkText(e.target.value)}
            placeholder="Her satıra bir öğrenci adı yazın..."
            className="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500 min-h-[200px]"
            aria-label="Toplu öğrenci ekleme alanı"
          />
          <button
            onClick={handleAddBulk}
            className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold"
          >
            <Save className="w-4 h-4 inline mr-2" />
            Kaydet
          </button>
        </div>
      ) : (
        <div className="mb-8 flex gap-2">
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleAddStudent()}
            placeholder="Öğrenci adı..."
            className="flex-1 p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500"
            maxLength={50}
            aria-label="Öğrenci adı"
          />
          <button
            onClick={handleAddStudent}
            className="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold"
          >
            Ekle
          </button>
        </div>
      )}

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {students.map(s => (
          <div
            key={s.id}
            className="p-4 bg-slate-50 rounded-xl border flex justify-between items-center font-bold text-xs"
          >
            <span className="truncate">{s.name}</span>
            <button
              onClick={() => onDeleteStudent(s.id)}
              className="text-red-300 hover:text-red-600 ml-2"
              aria-label={`${s.name} öğrenciyi sil`}
            >
              <X className="w-4 h-4" />
            </button>
          </div>
        ))}
      </div>

      {students.length === 0 && (
        <div className="text-center py-12 text-slate-400">
          <Users className="w-16 h-16 mx-auto mb-4 opacity-20" />
          <p>Henüz öğrenci eklenmedi</p>
        </div>
      )}
    </div>
  );
};

const WheelOfFortune = ({ students, drawnStudents, onDraw, onReset, onAddLog }) => {
  const [isSpinning, setIsSpinning] = useState(false);
  const [winner, setWinner] = useState(null);
  const [currentFlashName, setCurrentFlashName] = useState("");

  const handleDraw = () => {
    const available = students.filter(s => !drawnStudents.includes(s.id));
    if (!available.length) {
      alert("Tüm öğrenciler çekildi!");
      return;
    }

    setIsSpinning(true);
    setWinner(null);
    let count = 0;

    const interval = setInterval(() => {
      playRollSound();
      setCurrentFlashName(available[Math.floor(Math.random() * available.length)].name);
      count++;
      
      if (count > 25) {
        clearInterval(interval);
        const selected = available[Math.floor(Math.random() * available.length)];
        setWinner(selected);
        onDraw(selected.id);
        setIsSpinning(false);
      }
    }, 80);
  };

  return (
    <div className="bg-slate-900 rounded-3xl p-10 text-center shadow-2xl min-h-[500px] flex flex-col justify-center">
      <h2 className="text-indigo-400 font-bold uppercase mb-10 flex items-center justify-center gap-2">
        <Sparkles className="w-5 h-5" />
        Şans Çarkı / Kura
      </h2>

      <div className="h-40 flex items-center justify-center mb-10 text-white">
        {isSpinning ? (
          <div className="text-6xl font-bold animate-pulse">{currentFlashName}</div>
        ) : winner ? (
          <div className="text-7xl font-bold text-yellow-400 animate-bounce">{winner.name}</div>
        ) : (
          <div className="text-3xl font-bold text-slate-700">Hazır Bekliyor</div>
        )}
      </div>

      <div className="flex gap-4 justify-center flex-wrap">
        <button
          onClick={handleDraw}
          disabled={isSpinning}
          className="bg-indigo-600 hover:bg-indigo-500 text-white px-12 py-5 rounded-3xl font-bold text-2xl shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Kura çek"
        >
          ÇEK!
        </button>
        <button
          onClick={onReset}
          className="bg-slate-800 text-white px-6 py-5 rounded-3xl font-bold text-xs hover:bg-slate-700"
          aria-label="Kurayı sıfırla"
        >
          Sıfırla
        </button>
      </div>

      {winner && (
        <div className="mt-12 flex justify-center flex-wrap gap-2">
          {[-5, -4, -3, -2, -1, 1, 2, 3, 4, 5].map(v => (
            <button
              key={v}
              onClick={() => {
                onAddLog(winner.id, 'KURA', v, 'Kura Ödülü');
                setWinner(null);
              }}
              className={`w-10 h-10 rounded-xl font-bold text-white transition-all hover:scale-110 ${
                v > 0 ? 'bg-emerald-500' : 'bg-rose-500'
              }`}
              aria-label={`${v > 0 ? '+' : ''}${v} puan ekle`}
            >
              {v > 0 ? `+${v}` : v}
            </button>
          ))}
        </div>
      )}
    </div>
  );
};

// ============================================================================
// MAIN APP
// ============================================================================

function App() {
  const [page, setPage] = useState('dashboard');
  const [classes, setClasses] = useLocalStorageState('ap_v13_classes', []);
  const [selClass, setSelClass] = useState(null);
  const [students, setStudents] = useState([]);
  const [homeworks, setHomeworks] = useState([]);
  const [exams, setExams] = useState([]);
  const [drawnStudents, setDrawnStudents] = useState([]);

  useEffect(() => {
    if (selClass) {
      setStudents(storage.get(`s13_${selClass.id}`, []));
      setHomeworks(storage.get(`h13_${selClass.id}`, []));
      setExams(storage.get(`e13_${selClass.id}`, []));
    }
  }, [selClass]);

  const saveStudents = useCallback((newStudents) => {
    setStudents(newStudents);
    storage.set(`s13_${selClass.id}`, newStudents);
  }, [selClass]);

  const saveHomeworks = useCallback((newHomeworks) => {
    setHomeworks(newHomeworks);
    storage.set(`h13_${selClass.id}`, newHomeworks);
  }, [selClass]);

  const saveExams = useCallback((newExams) => {
    setExams(newExams);
    storage.set(`e13_${selClass.id}`, newExams);
  }, [selClass]);

  const addLog = useCallback((stdId, type, amount, reason) => {
    const updated = students.map(s => {
      if (s.id === stdId) {
        const newPuan = (Number(s.puan) || 0) + Number(amount);
        return {
          ...s,
          puan: newPuan,
          logs: [{
            date: new Date().toLocaleString('tr-TR'),
            type,
            amount: Number(amount),
            reason: sanitize(reason),
            currentTotal: newPuan
          }, ...(s.logs || [])]
        };
      }
      return s;
    });
    saveStudents(updated);
  }, [students, saveStudents]);

  const handleAddClass = () => {
    const name = prompt("Sınıf Adı:");
    const cleaned = sanitize(name);
    if (cleaned) {
      setClasses([...classes, { id: generateId(), name: cleaned }]);
    }
  };

  const handleDeleteClass = (id) => {
    if (confirm("Bu sınıf silinecek. Emin misiniz?")) {
      setClasses(classes.filter(c => c.id !== id));
      storage.remove(`s13_${id}`);
      storage.remove(`h13_${id}`);
      storage.remove(`e13_${id}`);
    }
  };

  const handleAddStudent = (name) => {
    saveStudents([...students, {
      id: generateId(),
      name,
      puan: 0,
      logs: []
    }]);
  };

  const handleAddBulkStudents = (names) => {
    const newStudents = names.map(name => ({
      id: generateId(),
      name,
      puan: 0,
      logs: []
    }));
    saveStudents([...students, ...newStudents]);
  };

  const handleDeleteStudent = (id) => {
    if (confirm("Bu öğrenci silinecek. Emin misiniz?")) {
      saveStudents(students.filter(s => s.id !== id));
    }
  };

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-slate-50">
        <nav className="bg-slate-900 text-white p-5 flex justify-between items-center border-b-4 border-indigo-600">
          <h1
            onClick={() => {
              setPage('dashboard');
              setSelClass(null);
            }}
            className="text-xl font-bold cursor-pointer flex items-center gap-2"
            role="button"
            tabIndex={0}
          >
            Asistan <span className="text-indigo-400">Pro V13</span>
          </h1>
          {selClass && (
            <div className="flex items-center gap-3">
              <span className="bg-indigo-600 px-4 py-1 rounded-lg text-xs font-bold">
                {selClass.name}
              </span>
            </div>
          )}
        </nav>

        <main className="p-6 max-w-7xl mx-auto">
          {page === 'dashboard' && (
            <Dashboard
              classes={classes}
              onAddClass={handleAddClass}
              onSelectClass={(c) => {
                setSelClass(c);
                setPage('list');
              }}
              onDeleteClass={handleDeleteClass}
            />
          )}

          {selClass && (
            <>
              <div className="flex flex-wrap gap-2 p-2 bg-white rounded-2xl w-fit shadow-sm border mx-auto md:mx-0 mb-6">
                <Tab active={page === 'list'} onClick={() => setPage('list')} icon={Users} label="Öğrenci" />
                <Tab active={page === 'hw'} onClick={() => setPage('hw')} icon={BookOpen} label="Ödev" />
                <Tab active={page === 'wheel'} onClick={() => setPage('wheel')} icon={Sparkles} label="Kura" />
                <Tab active={page === 'exam'} onClick={() => setPage('exam')} icon={FileText} label="Sınav" />
                <Tab active={page === 'rank'} onClick={() => setPage('rank')} icon={Trophy} label="Skor" />
              </div>

              {page === 'list' && (
                <StudentList
                  students={students}
                  onAddStudent={handleAddStudent}
                  onAddBulk={handleAddBulkStudents}
                  onDeleteStudent={handleDeleteStudent}
                />
              )}

              {page === 'wheel' && (
                <WheelOfFortune
                  students={students}
                  drawnStudents={drawnStudents}
                  onDraw={(id) => setDrawnStudents([...drawnStudents, id])}
                  onReset={() => setDrawnStudents([])}
                  onAddLog={addLog}
                />
              )}

              {page === 'rank' && (
                <div className="max-w-4xl mx-auto space-y-4 pt-10">
                  <h2 className="text-center font-bold text-4xl uppercase mb-10 text-slate-800 flex items-center justify-center gap-2">
                    <Trophy className="w-10 h-10 text-yellow-500" />
                    Liderlik Tablosu
                  </h2>
                  {students.sort((a, b) => b.puan - a.puan).map((s, i) => (
                    <div
                      key={s.id}
                      className="bg-white p-8 rounded-3xl shadow-xl flex justify-between items-center border-l-8 border-indigo-600 hover:scale-[1.02] transition-all"
                    >
                      <div className="flex items-center gap-8">
                        <span className="text-5xl font-bold text-slate-100">#{i + 1}</span>
                        <h3 className="text-xl font-bold text-slate-700">{s.name}</h3>
                      </div>
                      <div className="text-3xl font-bold text-indigo-600 bg-indigo-50 px-10 py-4 rounded-3xl">
                        {s.puan || 0} PUAN
                      </div>
                    </div>
                  ))}
                  {students.length === 0 && (
                    <div className="text-center py-12 text-slate-400">
                      <Trophy className="w-16 h-16 mx-auto mb-4 opacity-20" />
                      <p>Henüz öğrenci yok</p>
                    </div>
                  )}
                </div>
              )}
            </>
          )}
        </main>
      </div>
    </ErrorBoundary>
  );
}

export default App;
