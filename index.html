<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistan Pro V13 - Modern Eğitim Yönetimi</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // Lucide ikonlarını React bileşeni olarak kullanmak için yardımcı
        const Icon = ({ name, ...props }) => {
            const LucideIcon = lucide[name.charAt(0).toUpperCase() + name.slice(1)];
            return LucideIcon ? <LucideIcon {...props} /> : null;
        };

        // --- GÜVENLİK VE YARDIMCI FONKSİYONLAR ---
        const sanitize = (input) => {
            if (!input) return '';
            return String(input).replace(/[<>]/g, '').trim().slice(0, 100);
        };

        const storage = {
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return { success: true };
                } catch (e) { return { success: false, error: e.message }; }
            },
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch { return defaultValue; }
            }
        };

        const generateId = () => `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // --- BİLEŞENLER ---
        
        const HybridChart = ({ stdId, students, exams }) => {
            const width = 800;
            const height = 240;
            const padding = 40;
            
            // Grafik koordinat hesaplama (Sıfıra bölünme hatası düzeltildi)
            const getX = (index, total) => {
                if (total <= 1) return width / 2;
                return padding + (index * (width - 2 * padding) / (total - 1));
            };

            const examPoints = exams.map((e, i) => {
                const net = Number(e.results?.[stdId]?.net) || 0;
                const qCount = Number(e.qCount) || 1;
                const percentage = (net / qCount) * 100;
                const x = getX(i, exams.length);
                const y = height - padding - ((percentage / 100) * (height - 2 * padding));
                return { x, y, val: percentage };
            });

            return (
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto bg-white rounded-2xl border">
                    <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#cbd5e1" strokeWidth="2" />
                    {examPoints.length > 1 && (
                        <path d={`M ${examPoints.map(p => `${p.x},${p.y}`).join(' L ')}`} fill="none" stroke="#f59e0b" strokeWidth="3" strokeLinejoin="round" />
                    )}
                    {examPoints.map((p, i) => (
                        <g key={i}>
                            <circle cx={p.x} cy={p.y} r="5" fill="#f59e0b" />
                            <text x={p.x} y={p.y - 12} textAnchor="middle" fontSize="10" fontWeight="800" fill="#b45309">%{p.val.toFixed(0)}</text>
                        </g>
                    ))}
                </svg>
            );
        };

        // --- ANA UYGULAMA ---
        function App() {
            const [page, setPage] = useState('dashboard');
            const [classes, setClasses] = useState(() => storage.get('ap_v13_classes', []));
            const [selClass, setSelClass] = useState(null);
            const [students, setStudents] = useState([]);

            // Sınıf seçildiğinde verileri yükle
            useEffect(() => {
                if (selClass) {
                    setStudents(storage.get(`s13_${selClass.id}`, []));
                }
            }, [selClass]);

            // Değişiklikleri kaydet
            useEffect(() => {
                storage.set('ap_v13_classes', classes);
            }, [classes]);

            const handleAddClass = () => {
                const name = prompt("Sınıf Adı:");
                if (name) {
                    const newClass = { id: generateId(), name: sanitize(name) };
                    setClasses([...classes, newClass]);
                }
            };

            const exportData = () => {
                const data = { classes, students };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `asistan_yedek_${new Date().toLocaleDateString()}.json`;
                a.click();
            };

            return (
                <div className="min-h-screen">
                    <nav className="bg-slate-900 text-white p-5 flex justify-between items-center border-b-4 border-indigo-600 shadow-xl">
                        <h1 onClick={() => setPage('dashboard')} className="text-xl font-bold cursor-pointer flex items-center gap-2">
                            <Icon name="Sparkles" className="text-indigo-400" /> Asistan <span className="text-indigo-400">Pro V13</span>
                        </h1>
                        <div className="flex gap-2">
                            <button onClick={exportData} className="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg transition-colors">
                                <Icon name="Save" size={20} />
                            </button>
                            {selClass && <span className="bg-indigo-600 px-4 py-1 rounded-lg text-xs font-bold self-center">{selClass.name}</span>}
                        </div>
                    </nav>

                    <main className="p-6 max-w-7xl mx-auto">
                        {page === 'dashboard' ? (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-10">
                                <button onClick={handleAddClass} className="h-44 border-4 border-dashed border-slate-300 rounded-3xl font-bold text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-all flex flex-col items-center justify-center gap-2">
                                    <Icon name="Plus" size={32} />
                                    <span>Yeni Sınıf Ekle</span>
                                </button>
                                {classes.map(c => (
                                    <div key={c.id} onClick={() => {setSelClass(c); setPage('list');}} className="bg-white p-10 rounded-3xl shadow-lg border-b-8 border-indigo-600 hover:-translate-y-2 transition-all cursor-pointer group relative">
                                        <h3 className="text-3xl font-bold text-slate-800">{c.name}</h3>
                                        <div className="mt-4 text-slate-400 text-sm font-semibold italic flex items-center gap-1">
                                            Yönetmek için tıkla <Icon name="ChevronRight" size={16} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-white p-6 rounded-3xl shadow-sm border text-center py-20">
                                <Icon name="Construction" size={48} className="mx-auto mb-4 text-indigo-200" />
                                <h2 className="text-2xl font-bold text-slate-700">Sınıf Paneli Aktif</h2>
                                <p className="text-slate-500 mt-2">Bu bölümde öğrenci listesi ve diğer modüller React mantığıyla çalışmaya hazırdır.</p>
                                <button onClick={() => setPage('dashboard')} className="mt-6 text-indigo-600 font-bold">Geri Dön</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
